# Requirements Document - Agora Video/Audio Call API

## Introduction

This document defines the requirements for implementing backend APIs to support video and audio calling functionality using Agora SDK in the Chattrix application. The backend must provide secure token generation, call signaling, call history management, and quality monitoring capabilities to enable real-time communication between users.

## Glossary

- **Agora Token**: A security token generated by the backend to authenticate users when joining an Agora channel
- **Channel ID**: A unique identifier for a call room/session
- **Call Signaling**: The process of exchanging information to establish, manage, and terminate calls
- **Backend Server**: The server that handles business logic and data persistence
- **Token Server**: The service responsible for generating and managing Agora tokens
- **Call Metadata**: Information about a call including time, participants, and status
- **RTC (Real-Time Communication)**: Technology enabling real-time audio/video communication
- **WebSocket**: A protocol providing full-duplex communication channels over a single TCP connection
- **Call Participant**: A user who is either the caller or callee in a call session
- **Call Status**: The current state of a call (initiating, ringing, connected, ended, etc.)
- **Network Quality**: A measure of connection quality (excellent, good, poor, bad, veryBad)
- **Packet Loss Rate**: The percentage of data packets that fail to reach their destination
- **Round Trip Time (RTT)**: The time it takes for a signal to travel to a destination and back

## Requirements

### Requirement 1

**User Story:** As a caller, I want to initiate video or audio calls to my contacts, so that I can communicate with them in real-time.

#### Acceptance Criteria

1. WHEN a user initiates a call THEN the system SHALL validate that the callee exists and is a contact
2. WHEN a call is initiated THEN the system SHALL create a unique channel ID and call record with status "initiating"
3. WHEN a call is initiated THEN the system SHALL send a WebSocket notification to the callee with caller information
4. WHEN a call is not answered within 60 seconds THEN the system SHALL automatically update the status to "missed" and notify both participants
5. WHEN a user attempts to initiate a call while already in another call THEN the system SHALL reject the request with status code 409

### Requirement 2

**User Story:** As a callee, I want to receive call invitations and choose to accept or reject them, so that I can control my availability.

#### Acceptance Criteria

1. WHEN a callee receives a call invitation THEN the system SHALL deliver it via WebSocket with caller details
2. WHEN a callee accepts a call THEN the system SHALL update the call status to "connecting" and notify the caller
3. WHEN a callee rejects a call THEN the system SHALL update the call status to "rejected" and notify the caller with the rejection reason
4. WHEN a callee attempts to accept an expired call THEN the system SHALL return an error with code "CALL_TIMEOUT"
5. WHEN a callee is already in a call THEN the system SHALL reject incoming calls with status "busy"

### Requirement 3

**User Story:** As a call participant, I want the system to generate secure Agora tokens, so that I can join call channels securely.

#### Acceptance Criteria

1. WHEN a user requests an Agora token THEN the system SHALL generate it using the Agora App ID and App Certificate
2. WHEN generating a token THEN the system SHALL convert the user ID to a consistent numeric UID
3. WHEN a token is generated THEN the system SHALL set an expiration time between 60 and 86400 seconds
4. WHEN a token is generated THEN the system SHALL log the generation event for audit purposes
5. WHEN token generation fails THEN the system SHALL return status code 500 with error code "TOKEN_GENERATION_FAILED"

### Requirement 4

**User Story:** As a call participant, I want to refresh my Agora token before it expires, so that my call is not interrupted.

#### Acceptance Criteria

1. WHEN a user requests token refresh THEN the system SHALL verify they have an active call in the specified channel
2. WHEN refreshing a token THEN the system SHALL generate a new token with the same channel and role parameters
3. WHEN a token refresh is requested without an active call THEN the system SHALL return error code "NO_ACTIVE_CALL"
4. WHEN a token is refreshed THEN the system SHALL log the refresh event with partial old token information
5. WHEN token refresh fails THEN the system SHALL return status code 500 with error code "TOKEN_REFRESH_FAILED"

### Requirement 5

**User Story:** As a call participant, I want to end active calls, so that I can terminate communication when finished.

#### Acceptance Criteria

1. WHEN a participant ends a call THEN the system SHALL update the call status to "ended" and record the end time
2. WHEN a call is ended THEN the system SHALL calculate and store the call duration in seconds
3. WHEN a call is ended THEN the system SHALL notify the other participant via WebSocket
4. WHEN a call is ended THEN the system SHALL create call history entries for both participants
5. WHEN a call is ended THEN the system SHALL calculate average call quality metrics if available

### Requirement 6

**User Story:** As a user, I want to view my call history, so that I can track my past communications.

#### Acceptance Criteria

1. WHEN a user requests call history THEN the system SHALL return only their own call records
2. WHEN retrieving call history THEN the system SHALL support pagination with configurable page size (max 100)
3. WHEN retrieving call history THEN the system SHALL support filtering by call type (audio, video, all)
4. WHEN retrieving call history THEN the system SHALL support filtering by status (completed, missed, rejected, all)
5. WHEN retrieving call history THEN the system SHALL order results by timestamp in descending order

### Requirement 7

**User Story:** As a call participant, I want to report call quality metrics, so that the system can monitor and improve call performance.

#### Acceptance Criteria

1. WHEN a participant reports quality metrics THEN the system SHALL validate network quality values against allowed enums
2. WHEN quality metrics are reported THEN the system SHALL validate packet loss rate is between 0 and 1
3. WHEN quality metrics are reported THEN the system SHALL validate round trip time is a positive number
4. WHEN poor quality is detected THEN the system SHALL send a warning to the other participant via WebSocket
5. WHEN quality metrics are reported THEN the system SHALL cache the latest metrics in Redis with 5-minute TTL

### Requirement 8

**User Story:** As a system administrator, I want call status transitions to follow a valid state machine, so that data integrity is maintained.

#### Acceptance Criteria

1. WHEN a call status is updated THEN the system SHALL validate the transition is allowed by the state machine
2. WHEN transitioning from "ringing" THEN the system SHALL only allow "connecting" as the next status
3. WHEN transitioning from "connecting" THEN the system SHALL only allow "connected" or "disconnecting" as next statuses
4. WHEN transitioning from "connected" THEN the system SHALL only allow "disconnecting" as the next status
5. WHEN an invalid status transition is attempted THEN the system SHALL return error code "INVALID_STATUS_TRANSITION"

### Requirement 9

**User Story:** As a developer, I want all API endpoints to be properly authenticated and authorized, so that user data is protected.

#### Acceptance Criteria

1. WHEN any API endpoint is called THEN the system SHALL require a valid JWT authentication token
2. WHEN a user attempts to access another user's data THEN the system SHALL return status code 403 with error "UNAUTHORIZED_ACCESS"
3. WHEN a user generates a token THEN the system SHALL verify they are generating it for themselves
4. WHEN a user accesses call history THEN the system SHALL return only calls where they are a participant
5. WHEN authentication fails THEN the system SHALL return status code 401 with appropriate error message

### Requirement 10

**User Story:** As a system administrator, I want rate limiting on API endpoints, so that the system is protected from abuse.

#### Acceptance Criteria

1. WHEN token generation is requested THEN the system SHALL limit requests to 10 per minute per user
2. WHEN call initiation is requested THEN the system SHALL limit requests to 5 per minute per user
3. WHEN call history is requested THEN the system SHALL limit requests to 20 per minute per user
4. WHEN rate limit is exceeded THEN the system SHALL return status code 429 with error "RATE_LIMIT_EXCEEDED"
5. WHEN rate limit is applied THEN the system SHALL include retry-after header in the response

### Requirement 11

**User Story:** As a call participant, I want real-time notifications about call events, so that I can respond to call state changes immediately.

#### Acceptance Criteria

1. WHEN a call is initiated THEN the system SHALL send a "call_invitation" WebSocket event to the callee
2. WHEN a call is accepted THEN the system SHALL send a "call_accepted" WebSocket event to the caller
3. WHEN a call is rejected THEN the system SHALL send a "call_rejected" WebSocket event to the caller with reason
4. WHEN a call is ended THEN the system SHALL send a "call_ended" WebSocket event to the other participant
5. WHEN a call times out THEN the system SHALL send a "call_timeout" WebSocket event to both participants

### Requirement 12

**User Story:** As a developer, I want comprehensive error handling with structured error responses, so that clients can handle errors appropriately.

#### Acceptance Criteria

1. WHEN an error occurs THEN the system SHALL return a JSON response with success, error code, and message fields
2. WHEN a resource is not found THEN the system SHALL return status code 404 with error code "RESOURCE_NOT_FOUND"
3. WHEN validation fails THEN the system SHALL return status code 400 with specific validation error details
4. WHEN a server error occurs THEN the system SHALL log the error with stack trace and return status code 500
5. WHEN an error response is sent THEN the system SHALL include a request ID for debugging purposes

### Requirement 13

**User Story:** As a database administrator, I want proper database schema with indexes, so that query performance is optimized.

#### Acceptance Criteria

1. WHEN the calls table is created THEN the system SHALL include indexes on caller_id, callee_id, status, and channel_id
2. WHEN the call_history table is created THEN the system SHALL include indexes on user_id and timestamp
3. WHEN the call_quality_metrics table is created THEN the system SHALL include indexes on call_id and recorded_at
4. WHEN a call is deleted THEN the system SHALL cascade delete related quality metrics
5. WHEN storing timestamps THEN the system SHALL use UTC timezone consistently

### Requirement 14

**User Story:** As a system operator, I want environment-based configuration, so that the system can be deployed across different environments.

#### Acceptance Criteria

1. WHEN the application starts THEN the system SHALL load Agora App ID from environment variables
2. WHEN the application starts THEN the system SHALL load Agora App Certificate from environment variables
3. WHEN the application starts THEN the system SHALL load token expiration settings from environment variables
4. WHEN the application starts THEN the system SHALL load call timeout settings from environment variables
5. WHEN required environment variables are missing THEN the system SHALL fail to start with clear error messages

### Requirement 15

**User Story:** As a call participant, I want call statistics and analytics, so that I can understand my calling patterns.

#### Acceptance Criteria

1. WHEN a user requests statistics THEN the system SHALL calculate total number of calls for the specified period
2. WHEN calculating statistics THEN the system SHALL aggregate calls by type (audio vs video)
3. WHEN calculating statistics THEN the system SHALL aggregate calls by status (completed, missed, rejected)
4. WHEN calculating statistics THEN the system SHALL compute total duration in minutes
5. WHEN calculating statistics THEN the system SHALL compute average call duration in minutes
