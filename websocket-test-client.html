<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chattrix WebSocket Single User Test</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #333;
            padding: 30px;
        }
        .panel {
            background: #fff;
            border-radius: 12px;
            max-width: 600px;
            margin: 0 auto;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 25px;
            text-shadow: 0 2px 6px rgba(0,0,0,0.4);
        }
        label {
            font-weight: 600;
            display: block;
            margin-bottom: 6px;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        .btn {
            border: none;
            border-radius: 6px;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 600;
            color: white;
            margin-right: 8px;
        }
        .btn-primary { background: #667eea; }
        .btn-success { background: #10b981; }
        .btn-danger  { background: #ef4444; }
        .btn-warning { background: #f59e0b; }
        .messages {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
        }
        .message {
            background: white;
            border-left: 4px solid #667eea;
            margin-bottom: 10px;
            padding: 8px 10px;
            border-radius: 6px;
        }
        .message.sent { border-left-color: #10b981; }
        .message.received { border-left-color: #f59e0b; }
        .message.system { border-left-color: #6b7280; background: #f3f4f6; }
        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            color: white;
            margin-left: 10px;
        }
        .status-connected { background: #10b981; }
        .status-disconnected { background: #ef4444; }
    </style>
</head>
<body>
<h1>Chattrix WebSocket Client</h1>

<div class="panel">
    <h2>
        User
        <span id="status" class="status-badge status-disconnected">Disconnected</span>
    </h2>

    <label>Server URL</label>
    <input type="text" id="serverUrl" value="ws://localhost:8080/chattrix-api/v1/chat">

    <label>Username</label>
    <input type="text" id="username" value="example">

    <label>Password</label>
    <input type="text" id="password" value="password">

    <button class="btn btn-primary" onclick="login()">Login & Connect</button>
    <button class="btn btn-danger" onclick="disconnect()">Disconnect</button>

    <label>Token</label>
    <input type="text" id="token" placeholder="Auto-filled after login" readonly>

    <label>Conversation ID</label>
    <input type="text" id="conversationId" placeholder="Enter conversation ID">

    <label>Message</label>
    <textarea id="messageContent" placeholder="Type your message..."></textarea>

    <button class="btn btn-success" onclick="sendMessage()">Send Message</button>
    <button class="btn btn-warning" onclick="startTyping()">Start Typing</button>
    <button class="btn btn-warning" onclick="stopTyping()">Stop Typing</button>

    <div id="typingIndicator" style="display:none; margin-top:10px; color:#92400e; background:#fef3c7; padding:6px 10px; border-left:4px solid #f59e0b; border-radius:6px;"></div>

    <div id="messages" class="messages"></div>
</div>

<script>
    const API_BASE = 'http://localhost:8080/chattrix-api/api';
    let ws = null;
    let token = null;

    async function login() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        addMessage('system', `Logging in as ${username}...`);
        const res = await fetch(`${API_BASE}/v1/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ usernameOrEmail: username, password })
        });
        const data = await res.json();
        if (data.success && data.data.accessToken) {
            token = data.data.accessToken;
            document.getElementById('token').value = token;
            addMessage('system', '‚úÖ Login successful!');
            connectWebSocket();
        } else {
            addMessage('system', `‚ùå Login failed: ${data.message}`);
        }
    }

    function connectWebSocket() {
        if (!token) { addMessage('system', '‚ùå Please login first!'); return; }
        const wsUrl = `${document.getElementById('serverUrl').value}?token=${token}`;
        ws = new WebSocket(wsUrl);
        addMessage('system', 'Connecting to WebSocket...');

        ws.onopen = () => {
            addMessage('system', '‚úÖ Connected!');
            setStatus(true);
        };
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'chat.message') {
                const msg = data.payload;
                addMessage('received', `[${msg.sender.username}]: ${msg.content}`);
            } else if (data.type === 'typing.indicator') {
                const users = data.payload.typingUsers || [];
                if (users.length > 0) showTyping(`${users.map(u=>u.username).join(', ')} is typing...`);
                else hideTyping();
            } else if (data.type === 'user.status') {
                const s = data.payload.isOnline ? 'online' : 'offline';
                addMessage('system', `üë§ ${data.payload.username} is now ${s}`);
            }
        };
        ws.onerror = (e) => addMessage('system', `‚ùå WebSocket error`);
        ws.onclose = () => { setStatus(false); addMessage('system', '‚ö†Ô∏è Disconnected'); };
    }

    function disconnect() {
        if (ws) { ws.close(); ws = null; addMessage('system', 'Disconnected'); }
    }

    function sendMessage() {
        if (!ws || ws.readyState !== WebSocket.OPEN) { addMessage('system', '‚ùå Not connected'); return; }
        const conversationId = parseInt(document.getElementById('conversationId').value);
        const content = document.getElementById('messageContent').value;
        if (!conversationId || !content) return;
        const message = { type: 'chat.message', payload: { conversationId, content } };
        ws.send(JSON.stringify(message));
        addMessage('sent', `You: ${content}`);
        document.getElementById('messageContent').value = '';
    }

    function startTyping() {
        const conversationId = parseInt(document.getElementById('conversationId').value);
        if (ws && conversationId) ws.send(JSON.stringify({ type: 'typing.start', payload: { conversationId } }));
    }

    function stopTyping() {
        const conversationId = parseInt(document.getElementById('conversationId').value);
        if (ws && conversationId) ws.send(JSON.stringify({ type: 'typing.stop', payload: { conversationId } }));
    }

    function addMessage(type, text) {
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.innerHTML = `<div>${text}</div>`;
        document.getElementById('messages').appendChild(div);
        const msgBox = document.getElementById('messages');
        msgBox.scrollTop = msgBox.scrollHeight;
    }

    function showTyping(text) {
        const el = document.getElementById('typingIndicator');
        el.textContent = text;
        el.style.display = 'block';
    }
    function hideTyping() { document.getElementById('typingIndicator').style.display = 'none'; }
    function setStatus(connected) {
        const s = document.getElementById('status');
        s.textContent = connected ? 'Connected' : 'Disconnected';
        s.className = connected ? 'status-badge status-connected' : 'status-badge status-disconnected';
    }
</script>
</body>
</html>
